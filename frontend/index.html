<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mother+DC PO Validation - POReviewSystem</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .validation-container { max-width: 1400px; margin: 0 auto; }
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        @media (max-width: 900px) { .upload-grid { grid-template-columns: 1fr; } }
        
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        .upload-zone:hover { border-color: var(--primary-color); background: #FAFAFA; }
        .upload-zone.has-file { border-color: #10b981; background: #ecfdf5; }
        .upload-zone-icon { font-size: 48px; margin-bottom: 12px; }
        .upload-zone-text { font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .upload-zone-hint { font-size: 0.85rem; color: var(--text-muted); }
        
        .validation-section { display: none; margin-top: 32px; }
        .validation-section.active { display: block; }
        
        .summary-banner {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 24px;
        }
        .summary-banner.success { background: #d1fae5; color: #065f46; }
        .summary-banner.warning { background: #fef3c7; color: #92400e; }
        .summary-banner.error { background: #fee2e2; color: #991b1b; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); }
        .stat-value.danger { color: #dc2626; }
        .stat-value.warning { color: #ea580c; }
        
        .results-table { width: 100%; border-collapse: collapse; margin-top: 16px; background: white; }
        .results-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }
        .results-table tr:hover { background: #fafafa; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-over { background: #fef3c7; color: #92400e; }
        .status-under { background: #fee2e2; color: #991b1b; }
        .status-extra { background: #fce7f3; color: #831843; }
        .status-inventory-low { background: #fef3c7; color: #92400e; }
        .status-out-of-stock { background: #fee2e2; color: #991b1b; }
        
        .dc-breakdown { font-size: 0.85rem; color: var(--text-muted); }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 24px;
        }
        
        .recent-reviews {
            margin-top: 32px;
        }
        .review-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .review-info { flex: 1; }
        .review-title { font-weight: 600; margin-bottom: 4px; }
        .review-meta { font-size: 0.85rem; color: var(--text-muted); }
        .review-badge {
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .review-badge.issues { background: #fee2e2; color: #991b1b; }
        .global-loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), #f59e0b);
            transition: width 0.3s ease, opacity 0.2s ease;
            opacity: 0;
            z-index: 2000;
        }
        .global-loading-bar.active { width: 100%; opacity: 1; animation: loadingPulse 1s ease-in-out infinite; }
        @keyframes loadingPulse { from { opacity: 0.4; } to { opacity: 1; } }
        .inline-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.6);
            border-top-color: #fff;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .dc-breakdown-list {
            margin-top: 8px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: none;
        }
        .dc-breakdown-item { font-size: 0.85rem; color: var(--text-muted); }
        .status-badge.ok { background: #ecfdf3; color: #166534; }
        .dc-chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            margin: 4px;
            font-size: 0.85rem;
        }
        .inventory-pill {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 6px 10px;
            background: #f1f5f9;
            border-radius: 6px;
            font-weight: 600;
        }
        .po-meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .pallet-block { border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; margin-top: 8px; background: #f8fafc; }
        .pallet-title { font-weight: 600; color: var(--text-main); }
        .pallet-subtitle { font-size: 0.85rem; color: var(--text-muted); }
        .pallet-total { font-size: 0.9rem; margin-top: 4px; }
        .dc-summary-card { display: flex; flex-direction: column; align-items: flex-start; }
        .dc-summary-title { font-weight: 700; color: var(--text-main); }
        .dc-summary-meta { margin-top: 6px; }
        .unregistered-flag { color: var(--danger-color); font-size: 0.8rem; margin-top: 4px; }
        .btn-link {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="globalLoadingBar" class="global-loading-bar"></div>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="/data/nf_logo.png" alt="Company Logo" class="sidebar-logo">
            </div>
            <ul class="nav-links">
                <li class="nav-item">
                    <a href="index.html" class="nav-link active">
                        <span class="nav-icon">ğŸ”</span> PO Validation
                    </a>
                </li>
                <li class="nav-item">
                    <a href="emd.html" class="nav-link">
                        <span class="nav-icon">âœï¸</span> EMD (Manual)
                    </a>
                </li>
                <li class="nav-item">
                    <a href="admin.html" class="nav-link">
                        <span class="nav-icon">âš™ï¸</span> Admin
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="page-title">Mother+DC PO Validation</div>
            </header>

            <!-- Content Body -->
            <div class="content-body">
                <div class="validation-container">
                    
                    <!-- Upload Section -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">PO íŒŒì¼ ì—…ë¡œë“œ</div>
                            </div>
                        <p style="color: var(--text-muted); margin-bottom: 24px;">
                            Mother POì™€ DC POë¥¼ ì—…ë¡œë“œí•˜ì—¬ í• ë‹¹ëŸ‰ ê²€ì¦ ë° ì¬ê³  í™•ì¸ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
                        </p>
                        
                        <div class="upload-grid">
                            <!-- Mother PO Upload -->
                            <div>
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Mother PO (ì´ê´„ PO)</label>
                                <div class="upload-zone" id="motherPoZone">
                                    <div class="upload-zone-icon">ğŸ“„</div>
                                    <div class="upload-zone-text" id="motherPoText">PDF íŒŒì¼ ì„ íƒ</div>
                                    <div class="upload-zone-hint">í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                                    <input type="file" id="motherPoInput" accept=".pdf" style="display: none;">
                                </div>
                            </div>
                            
                            <!-- DC PO Upload -->
                            <div>
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;">DC PO (DCë³„ í• ë‹¹ PO)</label>
                                <div class="upload-zone" id="dcPoZone">
                                    <div class="upload-zone-icon">ğŸ“„</div>
                                    <div class="upload-zone-text" id="dcPoText">PDF íŒŒì¼ ì„ íƒ</div>
                                    <div class="upload-zone-hint">í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                                    <input type="file" id="dcPoInput" accept=".pdf" style="display: none;">
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 24px;">
                            <button id="validateBtn" class="btn btn-primary" disabled style="min-width: 200px;">
                                ì‹œì‘
                            </button>
                            <button id="clearBtn" class="btn btn-secondary" style="min-width: 120px; margin-left: 12px;">
                                ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                    
                    <!-- Validation Results Section -->
                    <div id="validationResults" class="validation-section">
                        
                        <!-- Summary Banner -->
                        <div id="summaryBanner"></div>

                        <!-- PO Meta -->
                        <div id="poMetaCard" class="card" style="display:none;">
                            <div class="card-header">
                                <div class="card-title">PO ì •ë³´</div>
                            </div>
                            <div id="poMetaBody" class="po-meta-grid"></div>
                        </div>
                        
                        <!-- Stats Grid -->
                        <div class="stats-grid" id="statsGrid"></div>

                        <div id="dcTotalsCard" class="card" style="display: none;">
                            <div class="card-header">
                                <div class="card-title">DC í•©ê³„ ë° íŒ”ë › ìš”ì•½</div>
                            </div>
                            <div id="dcTotalsList"></div>
                        </div>

                        <div id="skuTableCard" class="card" style="display: none;">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">SKU ìƒì„¸ ê²€ì¦</div>
                                    <div style="color: var(--text-muted); font-size: 0.9rem;">
                                        Mother/DC ìˆ˜ëŸ‰ê³¼ ì¬ê³  ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”. ê¸°ë³¸ì€ MAIN+SUB í†µí•© ì¬ê³ ì´ë©°, íƒ­ìœ¼ë¡œ MAIN ë˜ëŠ” SUB ë‹¨ë…ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <span style="font-size:0.85rem; color:var(--text-muted);">ì¬ê³  ë³´ê¸°</span>
                                    <div id="inventoryToggle" class="btn-group" role="group" aria-label="inventory modes">
                                        <button type="button" class="btn btn-secondary" data-mode="combined">MAIN+SUB</button>
                                        <button type="button" class="btn btn-secondary" data-mode="main">MAIN</button>
                                        <button type="button" class="btn btn-secondary" data-mode="sub">SUB</button>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="results-table">
                                    <thead>
                                        <tr>
                                            <th>SKU / ìƒí’ˆëª…</th>
                                            <th>íŒ© ì‚¬ì´ì¦ˆ</th>
                                            <th>Mother ìˆ˜ëŸ‰/ì¹´í†¤</th>
                                            <th>DC ì´í•© ìˆ˜ëŸ‰/ì¹´í†¤</th>
                                            <th>ì°¨ì´</th>
                                            <th>ìƒíƒœ</th>
                                            <th>ì¬ê³  (ì„ íƒ ëª¨ë“œ)</th>
                                            <th>ë¶€ì¡± ìˆ˜ëŸ‰</th>
                                            <th>DC Breakdown</th>
                                        </tr>
                                    </thead>
                                    <tbody id="skuTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Mismatches Section -->
                        <div id="mismatchSection" class="card" style="display: none;">
                            <div class="card-header">
                                <div class="card-title">í• ë‹¹ëŸ‰ ë¶ˆì¼ì¹˜ í•­ëª©</div>
                            </div>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                        <th>Mother PO ìˆ˜ëŸ‰</th>
                                        <th>DC ì´í•© ìˆ˜ëŸ‰</th>
                                        <th>ì°¨ì´</th>
                                        <th>ìƒíƒœ</th>
                                        <th>DCë³„ í• ë‹¹</th>
                                    </tr>
                                </thead>
                                <tbody id="mismatchTableBody"></tbody>
                            </table>
                        </div>
                        
                        <!-- Inventory Warnings Section -->
                        <div id="inventorySection" class="card" style="display: none; margin-top: 24px;">
                            <div class="card-header">
                                <div class="card-title">ì¬ê³  ë¶€ì¡± ê²½ê³ </div>
                            </div>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                        <th>PO ìˆ˜ëŸ‰</th>
                                        <th>ê°€ìš© ì¬ê³ </th>
                                        <th>ë¶€ì¡± ìˆ˜ëŸ‰</th>
                                        <th>ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTableBody"></tbody>
                            </table>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button id="downloadCsvBtn" class="btn btn-primary">
                                CSV ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button id="generateOrderBtn" class="btn btn-success">
                                Order Import ìƒì„±
                            </button>
                        </div>
                    </div>
                    
                    <!-- Recent Reviews Widget -->
                    <div class="recent-reviews">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">ğŸ“œ ìµœê·¼ ê²€ì¦ ê¸°ë¡</div>
                            </div>
                            <div id="recentReviewsList">
                                <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                                    ë¡œë”© ì¤‘...
                                </p>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </main>
    </div>

    <script src="assets/js/app.js"></script>
    <script>
        const API = 'http://localhost:8001';
        let motherFile = null;
        let dcFile = null;
        let validationData = null;

        const motherPoZone = document.getElementById('motherPoZone');
        const motherPoInput = document.getElementById('motherPoInput');
        const motherPoText = document.getElementById('motherPoText');
        const dcPoZone = document.getElementById('dcPoZone');
        const dcPoInput = document.getElementById('dcPoInput');
        const dcPoText = document.getElementById('dcPoText');
        const validateBtn = document.getElementById('validateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const validationResults = document.getElementById('validationResults');
        const summaryBannerEl = document.getElementById('summaryBanner');
        const statsGrid = document.getElementById('statsGrid');
        const mismatchSection = document.getElementById('mismatchSection');
        const mismatchTableBody = document.getElementById('mismatchTableBody');
        const inventorySection = document.getElementById('inventorySection');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const skuTableCard = document.getElementById('skuTableCard');
        const skuTableBody = document.getElementById('skuTableBody');
        const dcTotalsCard = document.getElementById('dcTotalsCard');
        const dcTotalsList = document.getElementById('dcTotalsList');
        const loadingBar = document.getElementById('globalLoadingBar');
        const poMetaCard = document.getElementById('poMetaCard');
        const poMetaBody = document.getElementById('poMetaBody');
        const inventoryToggle = document.getElementById('inventoryToggle');
        let inventoryMode = 'combined';

        function formatNumber(val) {
            if (val === undefined || val === null || isNaN(val)) return '0';
            return Number(val).toLocaleString('en-US');
        }

        function formatCurrencySafe(amount) {
            try {
                if (typeof formatCurrency === 'function') {
                    return formatCurrency(amount);
                }
            } catch (e) {
                console.warn('Fallback currency formatter in use.', e);
            }
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
        }

        function setLoadingState(isLoading) {
            if (isLoading) {
                loadingBar.classList.add('active');
                validateBtn.disabled = true;
                validateBtn.innerHTML = '<span class="inline-spinner"></span> ì§„í–‰ ì¤‘...';
            } else {
                loadingBar.classList.remove('active');
                validateBtn.disabled = !(motherFile && dcFile);
                validateBtn.innerHTML = 'ì‹œì‘';
            }
        }

        function setInventoryMode(mode) {
            inventoryMode = mode;
            if (inventoryToggle) {
                inventoryToggle.querySelectorAll('.btn').forEach(btn => {
                    if (btn.dataset.mode === mode) {
                        btn.classList.add('btn-primary');
                        btn.classList.remove('btn-secondary');
                    } else {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-secondary');
                    }
                });
            }
            if (validationData && validationData.sku_details) {
                renderSkuTable(validationData.sku_details);
            }
        }

        function getInventoryModeData(item, mode) {
            const modes = item.inventory_modes || {};
            const defaultMode = modes.combined || {};
            const selected = modes[mode] || defaultMode;
            const fallbackAvailable = item.inventory?.available_total ?? 0;
            const fallbackShortage = item.inventory?.shortage ?? 0;
            return {
                available: selected.available ?? fallbackAvailable,
                shortage: selected.shortage ?? fallbackShortage
            };
        }

        function resetResults() {
            validationResults.classList.remove('active');
            summaryBannerEl.className = '';
            summaryBannerEl.innerHTML = '';
            statsGrid.innerHTML = '';
            mismatchSection.style.display = 'none';
            inventorySection.style.display = 'none';
            skuTableCard.style.display = 'none';
            dcTotalsCard.style.display = 'none';
            poMetaCard.style.display = 'none';
        }

        motherPoZone.addEventListener('click', (e) => {
            e.stopPropagation();
            motherPoInput.click();
        });
        dcPoZone.addEventListener('click', (e) => {
            e.stopPropagation();
            dcPoInput.click();
        });

        motherPoInput.addEventListener('change', (e) => {
            e.stopPropagation();
            const file = e.target.files[0];
            if (file) {
                motherFile = file;
                motherPoZone.classList.add('has-file');
                motherPoText.textContent = `${file.name}`;
                checkValidateButton();
            }
        });

        dcPoInput.addEventListener('change', (e) => {
            e.stopPropagation();
            const file = e.target.files[0];
            if (file) {
                dcFile = file;
                dcPoZone.classList.add('has-file');
                dcPoText.textContent = `${file.name}`;
                checkValidateButton();
            }
        });

        function checkValidateButton() {
            validateBtn.disabled = !(motherFile && dcFile);
            if (!validateBtn.disabled && !loadingBar.classList.contains('active')) {
                validateBtn.innerHTML = 'ì‹œì‘';
            }
        }

        clearBtn.addEventListener('click', () => {
            motherFile = null;
            dcFile = null;
            validationData = null;
            motherPoInput.value = '';
            dcPoInput.value = '';
            motherPoZone.classList.remove('has-file');
            dcPoZone.classList.remove('has-file');
            motherPoText.textContent = 'PDF íŒŒì¼ ì„ íƒ';
            dcPoText.textContent = 'PDF íŒŒì¼ ì„ íƒ';
            resetResults();
            checkValidateButton();
            setInventoryMode('combined');
        });

        if (inventoryToggle) {
            inventoryToggle.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', () => setInventoryMode(btn.dataset.mode));
            });
            setInventoryMode('combined');
        }

        validateBtn.addEventListener('click', async () => {
            try {
                setLoadingState(true);
                const formData = new FormData();
                formData.append('mother_file', motherFile);
                formData.append('dc_file', dcFile);

                const res = await fetch(`${API}/api/validate_po_pair`, {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(errorText);
                }

                const result = await res.json();
                validationData = result.validation;

                displayValidationResults(validationData);
                loadRecentReviews();
                showToast('ê²€ì¦ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'success');
            } catch (err) {
                console.error(err);
                showToast(`ê²€ì¦ ì˜¤ë¥˜: ${err.message}`, 'error');
            } finally {
                setLoadingState(false);
            }
        });

        function buildStatusBadge(status) {
            const statusKey = (status || '').toLowerCase();
            if (statusKey === 'over') return { text: 'ì´ˆê³¼', cls: 'status-over' };
            if (statusKey === 'under') return { text: 'ë¯¸ë‹¬', cls: 'status-under' };
            if (statusKey === 'extra') return { text: 'ì¶”ê°€', cls: 'status-extra' };
            return { text: 'ì •ìƒ', cls: 'ok' };
        }

        function renderDcTotals(dcTotals) {
            if (!dcTotals || dcTotals.length === 0) {
                dcTotalsCard.style.display = 'none';
                dcTotalsList.innerHTML = '';
                return;
            }
            dcTotalsCard.style.display = 'block';
            dcTotalsList.innerHTML = dcTotals.map(dc => {
                const palletBlocks = (dc.pallets || []).map(p => `
                    <div class="pallet-block">
                        <div class="pallet-title">${p.name}</div>
                        <div class="pallet-subtitle">SKUs: ${(p.skus || []).join(', ') || '-'}</div>
                        <div class="pallet-total">${formatNumber(p.total_units)}u Â· ${formatNumber(p.total_cartons)}ctn</div>
                    </div>
                `).join('');
                return `
                    <div class="stat-card dc-summary-card">
                        <div class="dc-summary-title">DC #${dc.dc_id}</div>
                        <div class="dc-summary-meta">${formatNumber(dc.units)}u Â· ${formatNumber(dc.cartons)}ctn (${formatNumber(dc.skus)} SKU)</div>
                        ${palletBlocks}
                    </div>
                `;
            }).join('');
        }

        function renderSkuTable(details) {
            if (!details || details.length === 0) {
                skuTableCard.style.display = 'none';
                skuTableBody.innerHTML = '';
                return;
            }
            skuTableCard.style.display = 'block';
            skuTableBody.innerHTML = '';
            details.forEach((item, idx) => {
                const statusBadge = buildStatusBadge(item.status);
                const diffText = item.difference > 0 ? `+${item.difference}` : item.difference;
                const breakdownId = `dc-breakdown-${idx}`;
                const breakdownContent = (item.dc_breakdown || []).map(dc => `
                    <div class="dc-breakdown-item">
                        DC#${dc.dc_id}: ${formatNumber(dc.qty)}u / ${formatNumber(dc.cartons)}ctn
                    </div>
                `).join('') || '<div class="dc-breakdown-item">í• ë‹¹ ì—†ìŒ</div>';
                const invModeData = getInventoryModeData(item, inventoryMode);
                const availableVal = invModeData.available;
                const shortageVal = invModeData.shortage;
                const inventoryLabel = inventoryMode === 'main' ? 'MAIN' : (inventoryMode === 'sub' ? 'SUB' : 'MAIN+SUB');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <strong>${item.sku}</strong>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">${item.name || '-'}</div>
                    </td>
                    <td>${formatNumber(item.pack_size)}</td>
                    <td>${formatNumber(item.mother_qty)}<div style="color: var(--text-muted); font-size:0.8rem;">${formatNumber(item.mother_cartons)} ctn</div></td>
                    <td>${formatNumber(item.dc_total_qty)}<div style="color: var(--text-muted); font-size:0.8rem;">${formatNumber(item.dc_total_cartons)} ctn</div></td>
                    <td><strong>${diffText}</strong></td>
                    <td>
                        <span class="status-badge ${statusBadge.cls}">${statusBadge.text}</span>
                        ${item.is_unregistered_sku ? '<div class="unregistered-flag">ë¯¸ë“±ë¡ SKU</div>' : ''}
                    </td>
                    <td>
                        <div class="inventory-pill">${inventoryLabel} ${formatNumber(availableVal)}</div>
                    </td>
                    <td style="color:${shortageVal > 0 ? '#dc2626' : '#0f5132'}">${formatNumber(shortageVal)}</td>
                    <td>
                        <button class="btn-link breakdown-toggle" data-target="${breakdownId}">ë³´ê¸°</button>
                        <div id="${breakdownId}" class="dc-breakdown-list">${breakdownContent}</div>
                    </td>
                `;
                skuTableBody.appendChild(tr);
            });

            document.querySelectorAll('.breakdown-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = document.getElementById(btn.dataset.target);
                    if (!target) return;
                    target.style.display = target.style.display === 'block' ? 'none' : 'block';
                });
            });
        }

        function displayValidationResults(validation) {
            validationResults.classList.add('active');

            const summary = validation.summary || {};
            const mismatches = validation.mismatches || [];
            const inventoryWarnings = validation.inventory_warnings || [];
            const skuDetails = validation.sku_details || [];
            const totals = validation.totals || {};
            const byDcTotals = validation.by_dc_totals || [];
            const totalMatch = validation.total_match || {};
            const qtyDiff = Number(totalMatch.difference_units || 0);
            const qtyMatch = Boolean(totalMatch.qty_match);
            const poMeta = validation.po_meta || {};

            if (qtyMatch && mismatches.length === 0) {
                summaryBannerEl.className = 'summary-banner success';
                summaryBannerEl.innerHTML = 'ì´ ìˆ˜ëŸ‰ì´ ì¼ì¹˜í•©ë‹ˆë‹¤. ì„¸ë¶€ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”.';
            } else {
                const diffText = qtyDiff > 0 ? `+${formatNumber(qtyDiff)}` : formatNumber(qtyDiff);
                summaryBannerEl.className = 'summary-banner warning';
                summaryBannerEl.innerHTML = `ì´ ìˆ˜ëŸ‰ ì°¨ì´: ${diffText} (Mother ëŒ€ë¹„ DC) Â· ë¶ˆì¼ì¹˜ SKU ${formatNumber(mismatches.length)} Â· ì¬ê³  ê²½ê³  ${formatNumber(inventoryWarnings.length)}`;
            }

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">ì´ SKU ìˆ˜</div>
                    <div class="stat-value">${formatNumber(totals.total_skus || 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mother í•©ê³„ (ìˆ˜ëŸ‰/ì¹´í†¤)</div>
                    <div class="stat-value">${formatNumber(totals.total_units_mother || 0)}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">${formatNumber(totals.total_cartons_mother || 0)} ctn</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">DC í•©ê³„ (ìˆ˜ëŸ‰/ì¹´í†¤)</div>
                    <div class="stat-value">${formatNumber(totals.total_units_dc || 0)}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">${formatNumber(totals.total_cartons_dc || 0)} ctn</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì´ ìˆ˜ëŸ‰ ì°¨ì´</div>
                    <div class="stat-value ${qtyMatch ? '' : 'warning'}">${qtyMatch ? 'ì¼ì¹˜' : formatNumber(qtyDiff)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ë¶ˆì¼ì¹˜ / ì¬ê³  ê²½ê³ </div>
                    <div class="stat-value ${summary.mismatched_skus > 0 ? 'warning' : ''}">${formatNumber(summary.mismatched_skus || 0)}</div>
                    <div style="color: ${summary.total_inventory_warnings > 0 ? '#dc2626' : 'var(--text-muted)'}; font-size: 0.85rem;">ì¬ê³  ê²½ê³  ${formatNumber(summary.total_inventory_warnings || 0)}</div>
                </div>
            `;

            if (poMeta && Object.keys(poMeta).length > 0) {
                poMetaCard.style.display = 'block';
                poMetaBody.innerHTML = `
                    <div><strong>Mother PO</strong><div>${poMeta.po_number || '-'}</div></div>
                    <div><strong>DC PO</strong><div>${(poMeta.dc_po_numbers || []).join(', ') || '-'}</div></div>
                    <div><strong>Vendor</strong><div>${poMeta.vendor || '-'}</div></div>
                    <div><strong>ë‹´ë‹¹ì</strong><div>${poMeta.buyer || '-'}</div></div>
                    <div><strong>Ship Window</strong><div>${poMeta.ship_window || '-'}</div></div>
                    <div><strong>DC Ship Window</strong><div>${poMeta.dc_ship_window || '-'}</div></div>
                `;
            } else {
                poMetaCard.style.display = 'none';
            }

            renderDcTotals(byDcTotals);
            renderSkuTable(skuDetails);

            if (mismatches.length > 0) {
                mismatchSection.style.display = 'block';
                mismatchTableBody.innerHTML = '';

                mismatches.forEach(item => {
                    const statusInfo = buildStatusBadge(item.status);
                    const dcBreakdown = item.dc_breakdown.map(dc =>
                        `DC#${dc.dc_id}: ${dc.qty}`
                    ).join(', ');

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${item.sku}</strong></td>
                        <td>${item.mother_qty}</td>
                        <td>${item.dc_total}</td>
                        <td><strong>${item.difference > 0 ? '+' : ''}${item.difference}</strong></td>
                        <td><span class="status-badge ${statusInfo.cls}">${statusInfo.text}</span></td>
                        <td class="dc-breakdown">${dcBreakdown}</td>
                    `;
                    mismatchTableBody.appendChild(tr);
                });
            } else {
                mismatchSection.style.display = 'none';
            }

            if (inventoryWarnings.length > 0) {
                inventorySection.style.display = 'block';
                inventoryTableBody.innerHTML = '';

                inventoryWarnings.forEach(item => {
                    const statusClass = item.available_stock === 0 ? 'status-out-of-stock' : 'status-inventory-low';
                    const statusText = item.available_stock === 0 ? 'ì¬ê³  ì—†ìŒ' : 'ì¬ê³  ë¶€ì¡±';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${item.sku}</strong></td>
                        <td>${item.po_qty}</td>
                        <td>${item.available_stock}</td>
                        <td><strong>${item.shortage}</strong></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    `;
                    inventoryTableBody.appendChild(tr);
                });
            } else {
                inventorySection.style.display = 'none';
            }
        }

        document.getElementById('downloadCsvBtn').addEventListener('click', () => {
            const rows = validationData && validationData.sku_details ? validationData.sku_details : [];
            if (!rows || rows.length === 0) {
                showToast('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            let csv = 'SKU,Name,Pack Size,Mother Qty,Mother Cartons,DC Qty,DC Cartons,Difference,Status,Inventory Mode,Available,Shortage,DC Breakdown\n';

            rows.forEach(item => {
                const invModeData = getInventoryModeData(item, inventoryMode);
                const availableVal = invModeData.available;
                const shortageVal = invModeData.shortage;
                const breakdown = (item.dc_breakdown || []).map(dc => `DC#${dc.dc_id}: ${dc.qty}u/${dc.cartons}ctn`).join(' | ');
                const safeName = (item.name || '').replace(/"/g, '""');
                csv += `${item.sku || ''},"${safeName}",${item.pack_size || 0},${item.mother_qty || 0},${item.mother_cartons || 0},${item.dc_total_qty || 0},${item.dc_total_cartons || 0},${item.difference || 0},${item.status || ''},${inventoryMode},${availableVal},${shortageVal},"${breakdown}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `po_validation_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        });

        document.getElementById('generateOrderBtn').addEventListener('click', () => {
            if (!validationData) {
                alert('ë¨¼ì € ê²€ì¦ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            const hasMismatches = validationData.mismatches && validationData.mismatches.length > 0;

            if (hasMismatches) {
                const confirmed = confirm('ë¶ˆì¼ì¹˜ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ Order Importë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (!confirmed) return;
            }

            alert('Order Import ìƒì„± ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.\ní˜„ì¬ëŠ” MMD í˜ì´ì§€ì—ì„œ ìƒì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        });

        async function loadRecentReviews() {
            try {
                const res = await fetch(`${API}/api/po_reviews?limit=5`);
                const result = await res.json();

                const reviewsList = document.getElementById('recentReviewsList');

                if (result.status === 'success' && result.data.length > 0) {
                    reviewsList.innerHTML = '';

                    result.data.forEach(review => {
                        const hasIssues = review.mismatch_count > 0 || review.inventory_warning_count > 0;
                        const timestamp = new Date(review.timestamp).toLocaleString('ko-KR');

                        const div = document.createElement('div');
                        div.className = 'review-item';
                        div.innerHTML = `
                            <div class="review-info">
                                <div class="review-title">${review.mother_po} vs ${review.dc_po}</div>
                                <div class="review-meta">
                                    ${timestamp}
                                    <span class="review-badge ${hasIssues ? 'issues' : ''}">
                                        ë¶ˆì¼ì¹˜: ${review.mismatch_count} | ì¬ê³ ê²½ê³ : ${review.inventory_warning_count}
                                    </span>
                                </div>
                            </div>
                        `;
                        reviewsList.appendChild(div);
                    });
                } else {
                    reviewsList.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">ê²€ì¦ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (err) {
                console.error('Failed to load recent reviews:', err);
            }
        }

        loadRecentReviews();
    </script>
</body>
</html>
